# MoeChat 项目架构文档

## 项目概述

MoeChat 是一个功能丰富的 AI 聊天机器人系统，集成了情感处理、记忆管理、财务跟踪、天气服务和多媒体功能。该系统采用模块化架构设计，支持多种交互方式，包括语音对话、文本聊天和表情包互动。

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        MoeChat 系统架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  Web 客户端   │    │  GUI 客户端  │    │  CLI 客户端   │         │
│  │  (HTML/JS)   │    │  (Flet)     │    │  (Python)   │         │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │
│         │                 │                 │                 │
│         └─────────────────┴─────────────────┼─────────────────┘
│                                   │                           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    FastAPI 服务器                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │ chat_server │  │chat_core    │  │external_    │     │ │
│  │  │    .py      │  │    .py      │  │server.py    │     │ │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │ │
│  │         │                 │                 │           │ │
│  └─────────┼─────────────────┼─────────────────┼───────────┘ │
│            │                 │                 │             │
│  ┌─────────┼─────────────────┼─────────────────┼───────────┐ │
│  │         │                 │                 │           │ │
│  │  ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐ │ │
│  │  │   核心服务    │  │   记忆系统    │  │   插件系统    │ │ │
│  │  │             │  │             │  │             │ │ │
│  │  │ • 情感引擎   │  │ • 核心记忆   │  │ • 财务管理   │ │ │
│  │  │ • ASR/TTS    │  │ • 长期记忆   │  │ • 天气服务   │ │ │
│  │  │ • 声纹识别   │  │ • 知识库     │  │ • 表情包     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件架构

### 1. 服务器层 (Server Layer)

```
┌─────────────────────────────────────────────────────────────────┐
│                         FastAPI 服务器                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   chat_server.py                         │   │
│  │  主要 API 端点：                                          │   │
│  │  • POST /api/chat        - 核心聊天接口                  │   │
│  │  • POST /api/chat_v2     - 增强聊天接口                  │   │
│  │  • POST /api/asr         - 语音识别接口                  │   │
│  │  • POST /api/get_context - 获取上下文                    │   │
│  │  • POST /api/get_config  - 获取配置                      │   │
│  │  • POST /api/update_config - 更新配置                    │   │
│  │  • WS /api/asr_ws        - WebSocket ASR                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  chat_core.py                            │   │
│  │  核心处理逻辑：                                            │   │
│  │  • LLM 集成和流式响应                                    │   │
│  │  • 情感标签解析                                          │   │
│  │  • 语音合成队列管理                                      │   │
│  │  • 插件系统集成                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                external_server.py                         │   │
│  │  外部服务接口：                                            │   │
│  │  • GET /stream_chat     - 流式聊天                        │   │
│  │  • GET /img_search       - 图片搜索                        │   │
│  │  • POST /audio          - 音频处理                        │   │
│  │  • 天气/图片/表情包服务                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 核心服务层 (Core Services)

```
┌─────────────────────────────────────────────────────────────────┐
│                          核心服务层                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     情感系统                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │emotion_     │  │meme_system/ │  │   情感状态   │     │   │
│  │  │engine.py    │  │             │  │   管理       │     │   │
│  │  │             │  │ • Emotion   │  │             │     │   │
│  │  │ • 情感分析   │  │   Service   │  │ • NORMAL     │     │   │
│  │  │ • 状态管理   │  │ • Keyword   │  │ • MELTDOWN   │     │   │
│  │  │ • 挫折处理   │  │   Loader    │  │ • RECOVERING│     │   │
│  │  │ • 心境指令   │  │ • 表情包    │  │             │     │   │
│  │  │             │  │   选择       │  │             │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     记忆系统                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │core_mem.py  │  │long_mem.py  │  │data_base.py │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ • 核心记忆   │  │ • 长期记忆   │  │ • 知识库     │     │   │
│  │  │ • 向量搜索   │  │ • 时间查询   │  │ • FAISS索引  │     │   │
│  │  │ • UUID管理   │  │ • 日记系统   │  │ • 语义检索   │     │   │
│  │  │ • 重要信息   │  │ • 嵌入向量   │  │ • 阈值过滤   │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     语音处理                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │SenseVoice   │  │Silero VAD   │  │   GPT-SoVITS │     │   │
│  │  │Small        │  │             │  │             │     │   │
│  │  │             │  │ • 语音活动   │  │ • 语音合成   │     │   │
│  │  │ • 语音识别   │  │   检测       │  │ • 情感TTS    │     │   │
│  │  │ • 多语言支持 │  │ • 实时流处理 │  │ • 参考音频   │     │   │
│  │  │ • 声纹验证   │  │ • 噪声过滤   │  │   选择       │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. 插件系统架构 (Plugin System)

```
┌─────────────────────────────────────────────────────────────────┐
│                          插件系统                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   插件管理器                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │financial/   │  │weather/     │  │   其他插件   │     │   │
│  │  │plugin.py    │  │main.py      │  │             │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ • 财务管理   │  │ • 天气信息   │  │ • 可扩展的   │     │   │
│  │  │ • 自然语言   │  │ • 地理位置   │  │   插件架构   │     │   │
│  │  │   解析       │  │ • 预报查询   │  │ • 标准接口   │     │   │
│  │  │ • 多轮对话   │  │ • 格式化输出 │  │   定义       │     │   │
│  │  │   完成       │  │             │  │             │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  财务插件详细架构                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │Financial    │  │Session      │  │Database     │     │   │
│  │  │Plugin       │  │StateManager │  │Manager      │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ • 关键词检测 │  │ • 会话状态   │  │ • SQLite     │     │   │
│  │  │ • API调用    │  │   管理       │  │   数据库     │     │   │
│  │  │ • 错误处理   │  │ • 事务完成   │  │ • 复式记账   │     │   │
│  │  │ • 结果返回   │  │   跟踪       │  │ • 账户余额   │     │   │
│  │  │             │  │             │  │   管理       │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. 数据存储架构 (Data Storage)

```
┌─────────────────────────────────────────────────────────────────┐
│                          数据存储                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   文件系统                               │   │
│  │                                                         │   │
│  │  data/                                                   │   │
│  │  ├── agents/{char}/                                      │   │
│  │  │   ├── core_mem.yml           # 核心记忆               │   │
│  │  │   ├── memorys/               # 长期记忆               │   │
│  │  │   │   ├── 2024-01-01.yaml     # 按日期存储           │   │
│  │  │   │   └── 2024-01-01.pkl      # 向量缓存             │   │
│  │  │   └── data_base/             # 知识库                 │   │
│  │  │       ├── world_book.yaml    # 世界知识             │   │
│  │  │       └── tmp/               # 临时文件             │   │
│  │  │           ├── labels/         # 标签向量             │   │
│  │  │           └── label.yaml      # 标签索引             │   │
│  │  └── transactions.db           # 财务数据库             │   │
│  │                                                         │   │
│  │  config.yaml                   # 主配置文件             │   │
│  │  emotion_state.json            # 情感状态               │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   数据库结构                             │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │              SQLite 财务数据库                     │   │
│  │  │                                                 │   │
│  │  │  transactions (交易主表)                           │   │
│  │  │  ├─ id INTEGER PRIMARY KEY                       │   │
│  │  │  ├─ date TEXT NOT NULL                           │   │
│  │  │  ├─ description TEXT NOT NULL                     │   │
│  │  │  ├─ total_amount REAL NOT NULL                    │   │
│  │  │  ├─ action TEXT NOT NULL                         │   │
│  │  │  ├─ category TEXT                                │   │
│  │  │  └─ created_at TEXT NOT NULL                     │   │
│  │  │                                                 │   │
│  │  │  entries (分录明细表)                             │   │
│  │  │  ├─ id INTEGER PRIMARY KEY                       │   │
│  │  │  ├─ transaction_id INTEGER                        │   │
│  │  │  ├─ account_name TEXT NOT NULL                   │   │
│  │  │  ├─ account_type TEXT NOT NULL                   │   │
│  │  │  ├─ debit_amount REAL DEFAULT 0                 │   │
│  │  │  ├─ credit_amount REAL DEFAULT 0                │   │
│  │  │  └─ created_at TEXT NOT NULL                     │   │
│  │  │                                                 │   │
│  │  │  account_balances (账户余额表)                    │   │
│  │  │  ├─ account_name TEXT PRIMARY KEY                │   │
│  │  │  ├─ account_type TEXT NOT NULL                   │   │
│  │  │  ├─ balance REAL NOT NULL DEFAULT 0              │   │
│  │  │  └─ last_updated TEXT NOT NULL                   │   │
│  │  └─────────────────────────────────────────────────┘   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5. 前端架构 (Frontend Architecture)

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Web 客户端                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │moechat_     │  │moechat_     │  │moechat_     │     │   │
│  │  │iphone_client│  │core.js      │  │style.css    │     │   │
│  │  │.html        │  │             │  │             │     │   │
│  │  │             │  │ • 音频处理   │  │ • 响应式     │     │   │
│  │  │ • UI布局     │  │ • SSE连接   │  │   设计       │     │   │
│  │  │ • 录音控制   │  │ • 消息渲染   │  │ • 主题切换   │     │   │
│  │  │ • 特效系统   │  │ • 特效触发   │  │ • 动画效果   │     │   │
│  │  │ • 主题切换   │  │ • 状态管理   │  │             │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   GUI 客户端                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │client_gui.py│  │ui.py        │  │client_      │     │   │
│  │  │             │  │             │  │utils.py     │     │   │
│  │  │ • Flet框架   │  │ • UI组件    │  │ • 音频处理   │     │   │
│  │  │ • 主窗口     │  │ • 布局管理   │  │ • 网络请求   │     │   │
│  │  │ • 事件处理   │  │ • 控件定义   │  │ • 状态管理   │     │   │
│  │  │             │  │ • 样式设置   │  │ • 工具函数   │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                    │                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   CLI 客户端                             │   │
│  │  ┌─────────────┐                                         │   │
│  │  │client_cli.py│                                         │   │
│  │  │             │                                         │   │
│  │  │ • 命令行界面 │                                         │   │
│  │  │ • 音频录制   │                                         │   │
│  │  │ • VAD检测    │                                         │   │
│  │  │ • 实时对话   │                                         │   │
│  │  │ • 状态显示   │                                         │   │
│  │  └─────────────┘                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 关键API接口位置

### 核心聊天API
- **位置**: `chat_server.py:483`
- **接口**: `POST /api/chat`
- **功能**: 主要的聊天接口，支持流式响应

### 增强聊天API
- **位置**: `chat_server.py:569`
- **接口**: `POST /api/chat_v2`
- **功能**: 增强版聊天接口，支持分离的音频和文本流

### 语音识别API
- **位置**: `chat_server.py:577`
- **接口**: `POST /api/asr`
- **功能**: 音频转文字

### WebSocket ASR
- **位置**: `chat_server.py:584`
- **接口**: `WS /api/asr_ws`
- **功能**: 实时语音识别WebSocket

### 上下文管理API
- **位置**: `chat_server.py:641`
- **接口**: `POST /api/get_context`
- **功能**: 获取对话上下文

### 配置管理API
- **位置**: `chat_server.py:647`
- **接口**: `POST /api/get_config`
- **功能**: 获取服务器配置

### 配置更新API
- **位置**: `chat_server.py:652`
- **接口**: `POST /api/update_config`
- **功能**: 运行时更新配置

### 外部服务API
- **位置**: `external_server.py`
- **接口**: `GET /stream_chat`, `GET /img_search`, `POST /audio`
- **功能**: 外部服务集成

## 关键服务位置

### 情感引擎
- **位置**: `emotion_engine.py`
- **功能**: 情感分析、状态管理、心境指令生成

### 记忆系统
- **核心记忆**: `utilss/core_mem.py`
- **长期记忆**: `utilss/long_mem.py`
- **知识库**: `utilss/data_base.py`

### 语音处理
- **ASR**: `utilss/sv.py`, SenseVoiceSmall模型
- **VAD**: `pysilero.py`, Silero VAD模型
- **TTS**: GPT-SoVITS API调用

### 插件系统
- **财务插件**: `plugins/financial/plugin.py`
- **天气服务**: `weather/main.py`
- **表情包系统**: `meme_system/emotion_service.py`

## 数据流程图

```
用户输入 → ASR处理 → 情感分析 → 记忆检索 → LLM处理 → 响应生成 → TTS合成 → 输出
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
  音频 →   文本 →   情感标签 → 上下文 →  回复 →   语音 →   播放
```

## 部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web 客户端    │    │   GUI 客户端    │    │   CLI 客户端    │
│   (浏览器)      │    │   (桌面应用)    │    │   (命令行)      │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────┬───────────┼──────────┬───────────┘
                     │           │          │
          ┌─────────▼───────────▼──────────▼───────────┐
          │              FastAPI 服务器 (8001)           │
          │                                         │
          │  ┌─────────────┐  ┌─────────────┐         │
          │  │chat_server  │  │chat_core    │         │
          │  └─────────────┘  └─────────────┘         │
          └─────────────────┬─────────────────────────┘
                            │
          ┌─────────────────▼─────────────────────────┐
          │                 外部服务                  │
          │                                         │
          │  ┌─────────────┐  ┌─────────────┐         │
          │  │external_    │  │socket_asr   │         │
          │  │server       │  │(8002)       │         │
          │  └─────────────┘  └─────────────┘         │
          └─────────────────────────────────────────┘
```

## 技术栈

### 后端技术
- **框架**: FastAPI, Uvicorn
- **AI模型**: SenseVoiceSmall, Silero VAD, GPT-SoVITS
- **向量数据库**: FAISS
- **数据库**: SQLite (财务数据), YAML文件 (记忆数据)
- **音频处理**: sounddevice, soundfile, pysilero

### 前端技术
- **Web客户端**: HTML5, CSS3, JavaScript (ES6+)
- **GUI客户端**: Flet框架
- **CLI客户端**: Python标准库

### 依赖服务
- **LLM API**: 支持OpenAI兼容的API
- **TTS API**: GPT-SoVITS服务
- **天气API**: 和风天气
- **图片搜索**: 多引擎支持

## 配置系统

配置文件 `config.yaml` 包含以下主要部分：

- **Core**: 基础系统配置
- **LLM**: 大语言模型API配置
- **GSV**: 语音合成配置
- **Agent**: 角色和记忆系统配置
- **Plugins**: 插件系统配置

## 扩展性设计

系统采用模块化设计，支持：
- 插件热插拔
- 多种客户端接入
- 配置热重载
- 服务水平扩展
- 自定义角色模板

---

*本架构文档涵盖了MoeChat项目的整体架构、关键组件、API接口和数据流程。系统设计注重模块化、可扩展性和用户体验。*